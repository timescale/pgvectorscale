name: Run code checks
on: [push, pull_request, workflow_dispatch]
permissions:
  contents: read

jobs:
  fmt:
    runs-on: ubuntu-latest

    container:
      image: timescaledev/rust-builder:latest-ubuntu-stable

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rustfmt
        run: cargo fmt --all -- --check

  clippy:
    runs-on: ubuntu-latest

    container:
      image: timescaledev/rust-builder:latest-ubuntu-stable

    env:
      MAKE_JOBS: 6
      PG_CONFIG_PATH: postgresql/bin/pg_config
      PG_INSTALL_DIR: postgresql
      PG_MAJOR_VER: 17
      PG_MINOR_VER: 0
      PG_SRC_DIR: pgbuild
      PG_VECTOR_VER: 0.7.4
      TAG_DIR: pgvectorscale
      TAG_GIT_REF: ${{ github.event.inputs.TAG_GIT_REF == '' && github.event.inputs.tag || github.event.inputs.TAG_GIT_REF}}
      TAG: ${{ github.event.inputs.tag }}
  
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux packages
        uses: ./.github/actions/install-packages
  
      - name: Install PostgreSQL ${{ env.PG_MAJOR_VER }}
        uses: ./.github/actions/install-postgres
        with:
          pg-version: ${{ env.PG_MAJOR_VER }}.${{ env.PG_MINOR_VER }}
          pg-src-dir: ~/${{ env.PG_SRC_DIR }}
          pg-install-dir: ~/${{ env.PG_INSTALL_DIR }}
  
      - name: Install pgvector ${{ env.PG_VECTOR_VER }}
        uses: ./.github/actions/install-pgvector
        with:
          pgvector-version: ${{ env.PG_VECTOR_VER }}
          pg-install-dir: ~/${{ env.PG_INSTALL_DIR }}
    
      - name: Install pgrx
        uses: ./.github/actions/install-pgrx
        with:
          pg-install-dir: ~/${{ env.PG_INSTALL_DIR }}
          pgrx-version: 0.12.5  

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings
